<script>
  // グローバル変数
  let currentFile = null;
  let currentData = null;
  let processedData = null;
  
  // ページ読み込み時の初期化
  document.addEventListener('DOMContentLoaded', function() {
    // プロファイルの読み込み
    loadProfiles();
    
    // タブ切り替えの設定
    setupTabs();
    
    // イベントリスナーの設定
    setupEventListeners();
  });
  
  // プロファイルの読み込み
  function loadProfiles() {
    google.script.run
      .withSuccessHandler(function(profiles) {
        const select = document.getElementById('profile-select');
        select.innerHTML = '<option value="">新規プロファイル</option>';
        
        for (const name in profiles) {
          const option = document.createElement('option');
          option.value = name;
          option.textContent = name;
          select.appendChild(option);
        }
      })
      .withFailureHandler(showError)
      .getProfiles();
  }
  
  // タブ切り替えの設定
  function setupTabs() {
    const tabs = document.querySelectorAll('.tab-button');
    tabs.forEach(tab => {
      tab.addEventListener('click', function() {
        // アクティブなタブの切り替え
        document.querySelector('.tab-button.active').classList.remove('active');
        this.classList.add('active');
        
        // タブコンテンツの切り替え
        const tabId = this.dataset.tab;
        document.querySelector('.tab-pane.active').classList.remove('active');
        document.getElementById(tabId).classList.add('active');
      });
    });
  }
  
  // イベントリスナーの設定
  function setupEventListeners() {
    // プロファイル選択
    document.getElementById('profile-select').addEventListener('change', function() {
      const name = this.value;
      if (name) {
        document.getElementById('profile-name').value = name;
        loadProfile(name);
      }
    });
    
    // プロファイル保存
    document.getElementById('save-profile').addEventListener('click', saveProfile);
    
    // プロファイル削除
    document.getElementById('delete-profile').addEventListener('click', deleteProfile);
    
    // ファイル選択
    document.getElementById('select-file').addEventListener('click', selectFile);
    
    // 変換実行
    document.getElementById('process').addEventListener('click', processData);
    
    // 保存
    document.getElementById('save').addEventListener('click', saveFile);
  }
  
  // プロファイルの読み込み
  function loadProfile(name) {
    google.script.run
      .withSuccessHandler(function(profile) {
        // 各設定をフォームに反映
        document.getElementById('reorder-settings').value = profile.reorder || '';
        document.getElementById('merge-settings').value = profile.merge || '';
        document.getElementById('extract-settings').value = profile.extract || '';
        document.getElementById('remove-settings').value = profile.remove || '';
        document.getElementById('add-settings').value = profile.add || '';
        
        // 都道府県設定
        if (profile.remove_prefecture) {
          document.getElementById('remove-prefecture-enabled').checked = profile.remove_prefecture.enabled;
          document.getElementById('remove-prefecture-columns').value = profile.remove_prefecture.column || '';
        }
        
        if (profile.get_pref_code) {
          document.getElementById('get-pref-code-enabled').checked = profile.get_pref_code.enabled;
          document.getElementById('pref-code-source').value = profile.get_pref_code.source_column || '';
          document.getElementById('pref-code-new').value = profile.get_pref_code.new_column || '都道府県コード';
        }
      })
      .withFailureHandler(showError)
      .getProfile(name);
  }
  
  // プロファイルの保存
  function saveProfile() {
    const name = document.getElementById('profile-name').value;
    if (!name) {
      showError('プロファイル名を入力してください');
      return;
    }
    
    const settings = {
      reorder: document.getElementById('reorder-settings').value,
      merge: document.getElementById('merge-settings').value,
      extract: document.getElementById('extract-settings').value,
      remove: document.getElementById('remove-settings').value,
      add: document.getElementById('add-settings').value,
      remove_prefecture: {
        enabled: document.getElementById('remove-prefecture-enabled').checked,
        column: document.getElementById('remove-prefecture-columns').value
      },
      get_pref_code: {
        enabled: document.getElementById('get-pref-code-enabled').checked,
        source_column: document.getElementById('pref-code-source').value,
        new_column: document.getElementById('pref-code-new').value
      }
    };
    
    google.script.run
      .withSuccessHandler(function() {
        loadProfiles();
        showMessage('プロファイルを保存しました');
      })
      .withFailureHandler(showError)
      .saveProfile(name, settings);
  }
  
  // プロファイルの削除
  function deleteProfile() {
    const name = document.getElementById('profile-select').value;
    if (!name) {
      showError('削除するプロファイルを選択してください');
      return;
    }
    
    if (!confirm('プロファイル「' + name + '」を削除してもよろしいですか？')) {
      return;
    }
    
    google.script.run
      .withSuccessHandler(function() {
        loadProfiles();
        document.getElementById('profile-name').value = '';
        showMessage('プロファイルを削除しました');
      })
      .withFailureHandler(showError)
      .deleteProfile(name);
  }
  
  // ファイルの選択
  function selectFile() {
    const fileInput = document.createElement('input');
    fileInput.type = 'file';
    fileInput.accept = '.csv';
    fileInput.style.display = 'none';
    
    fileInput.addEventListener('change', function(e) {
      const file = e.target.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = function(e) {
          const content = e.target.result;
          google.script.run
            .withSuccessHandler(function(data) {
              currentData = data;
              showPreview(data);
              document.getElementById('selected-file').textContent = file.name;
            })
            .withFailureHandler(showError)
            .processFileContent(content);
        };
        reader.readAsText(file);
      }
    });
    
    document.body.appendChild(fileInput);
    fileInput.click();
    document.body.removeChild(fileInput);
  }
  
  // ファイルの保存
  function saveFile() {
    if (!processedData) {
      showError('変換を実行してください');
      return;
    }
    
    const encoding = document.getElementById('encoding').value;
    // encodingの値に基づいて保存形式を決定
    const format = encoding === 'utf-8' ? 'csv' : 'sheets';
    const fileName = 'converted_data.' + (format === 'sheets' ? 'xlsx' : 'csv');
    
    google.script.run
      .withSuccessHandler(function(fileId) {
        showMessage('ファイルを保存しました');
        // 保存したファイルのリンクを表示
        const fileUrl = 'https://drive.google.com/file/d/' + fileId + '/view';
        document.getElementById('selected-file').innerHTML = 
          '<a href="' + fileUrl + '" target="_blank">' + fileName + '</a>';
      })
      .withFailureHandler(showError)
      .saveResultToDrive(processedData, fileName, format);
  }
  
  // データの変換処理
  function processData() {
    if (!currentData) {
      showError('CSVファイルを選択してください');
      return;
    }
    
    const settings = {
      reorder: document.getElementById('reorder-settings').value,
      merge: document.getElementById('merge-settings').value,
      extract: document.getElementById('extract-settings').value,
      remove: document.getElementById('remove-settings').value,
      add: document.getElementById('add-settings').value,
      remove_prefecture: {
        enabled: document.getElementById('remove-prefecture-enabled').checked,
        column: document.getElementById('remove-prefecture-columns').value
      },
      get_pref_code: {
        enabled: document.getElementById('get-pref-code-enabled').checked,
        source_column: document.getElementById('pref-code-source').value,
        new_column: document.getElementById('pref-code-new').value
      }
    };
    
    google.script.run
      .withSuccessHandler(function(data) {
        processedData = data;
        showPreview(data);
      })
      .withFailureHandler(showError)
      .processData(currentData, settings);
  }
  
  // プレビューの表示
  function showPreview(data) {
    const preview = document.getElementById('preview');
    const table = document.createElement('table');
    
    // ヘッダー行
    const thead = document.createElement('thead');
    const headerRow = document.createElement('tr');
    data[0].forEach(header => {
      const th = document.createElement('th');
      th.textContent = header;
      headerRow.appendChild(th);
    });
    thead.appendChild(headerRow);
    table.appendChild(thead);
    
    // データ行
    const tbody = document.createElement('tbody');
    for (let i = 1; i < Math.min(data.length, 11); i++) {
      const row = document.createElement('tr');
      data[i].forEach(cell => {
        const td = document.createElement('td');
        td.textContent = cell;
        row.appendChild(td);
      });
      tbody.appendChild(row);
    }
    table.appendChild(tbody);
    
    // プレビューの更新
    preview.innerHTML = '';
    preview.appendChild(table);
    
    // データが11行以上ある場合はその旨を表示
    if (data.length > 11) {
      const message = document.createElement('p');
      message.textContent = '... 他 ' + (data.length - 11) + ' 行';
      preview.appendChild(message);
    }
  }
  
  // エラーメッセージの表示
  function showError(message) {
    alert('エラー: ' + message);
  }
  
  // メッセージの表示
  function showMessage(message) {
    alert(message);
  }
</script> 