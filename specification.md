# Google Apps Script版 CSVレイアウト変更ツール仕様書

## 1. 概要

本ツールはCSVファイルのレイアウト（項目の構成や内容）を柔軟に変更するためのGoogle Apps Scriptで実装されたウェブアプリケーションである。Google Driveに保存されたCSVファイルを読み込み、項目の並べ替え、結合、文字の除去・追加などの操作を行うことができる。

## 2. 動作環境

- 実行環境: Google Apps Script (GAS)
- アクセス手段: ウェブアプリケーション（Google Chromeなど主要ブラウザ）
- 必要サービス:
  - Google アカウント
  - Google Drive
  - Google Sheets

## 3. 機能仕様

### 3.1 基本機能

| 機能ID | 機能名 | 説明 |
|--------|--------|------|
| F01 | CSVファイル読み込み | Google Drive上のCSVファイルを読み込む |
| F02 | 項目の並べ替え | CSVファイルの列（項目）の順序を変更する |
| F03 | 複数項目の結合 | 複数の列を結合して新しい列を作成する |
| F04 | 文字の除去 | 特定の列から指定された文字を削除する |
| F05 | 文字の追加 | 特定の列の値の前後に文字を追加する |
| F06 | Google Drive選択 | Google Drive上のファイルを選択して読み込む |
| F07 | プレビュー表示 | 変換後のCSVファイルのプレビューを表示する |
| F08 | 変換結果の保存 | 変更後のCSVファイルをGoogle Driveに保存する |
| F09 | プロファイル管理 | 変換設定をプロパティサービスまたはスプレッドシートとして保存・読み込み |
| F10 | 文字コード選択 | 出力時の文字コードをUTF-8/Shift-JISから選択 |
| F11 | 都道府県名除去 | 指定した住所項目から都道府県名を削除する |
| F12 | 都道府県コード取得 | 指定した項目に含まれる都道府県名から、対応する都道府県コードを新しい列として取得する |
| F13 | 文字列抽出 | 指定した項目から、指定した開始位置と文字数で文字列を抽出し、新しい列として追加する |

### 3.2 詳細仕様

#### 3.2.1 CSVファイル読み込み (F01)

- Google Drive上のCSVファイルを読み込む
- Google Sheets APIを使用してCSVデータを処理
- ファイル選択インターフェースでGoogle Drive上のCSVファイルを選択

#### 3.2.2 項目の並べ替え (F02)

- カンマ区切りで項目名を指定し、指定した順序に列を並べ替え
- 指定されなかった列は出力結果から除外される
- カンマを連続して指定した場合 (`,,`)、その位置にヘッダーおよび値が空の列を挿入する
- 指定されなかった列は元の順序を保持して末尾に配置

#### 3.2.3 複数項目の結合 (F03)

- 指定した複数の列を結合して新しい列を作成
- 結合時の区切り文字を指定可能
- 書式：`新項目名:結合元項目1,結合元項目2... 区切り文字`

#### 3.2.4 文字の除去 (F04)

- 特定の列から指定された文字を削除
- 複数の文字を指定可能
- 書式：`項目名:除去する文字1,除去する文字2...`

#### 3.2.5 文字の追加 (F05)

- 特定の列の値の前または後に文字を追加
- 書式：`項目名:位置:追加文字`
- 位置は「前」または「後」を指定

#### 3.2.6 Google Drive選択 (F06)

- Google Driveの選択インターフェースを使用してCSVファイルを選択
- Google Picker APIを使用してファイル選択ダイアログを表示

#### 3.2.7 プレビュー表示 (F07)

- 変換後のデータを表形式でプレビュー表示
- 最大10行を表示し、それ以上のデータがある場合はその旨を表示
- Google Sheets APIを使用してテーブル表示

#### 3.2.8 変換結果の保存 (F08)

- 変換後のCSVファイルをGoogle Driveに保存
- Google Driveへの保存形式（CSV、Google Sheets）を選択可能
- 保存先フォルダの選択が可能

#### 3.2.9 プロファイル管理 (F09)

- 変換設定をプロパティサービスに保存（ユーザー単位）
- または専用のGoogle Sheetsに設定を保存して共有可能
- プロファイルの選択・編集・削除が可能

#### 3.2.10 文字コード選択 (F10)

- Google Driveから読み込む際には文字コードは自動的に処理
- CSVとして出力する際の文字コードを選択可能（UTF-8またはShift-JIS）

#### 3.2.11 都道府県名除去 (F11)

- 「文字除去」セクション内の専用チェックボックスで機能の有効/無効を切り替え
- 対象となる住所項目名を指定する入力欄を設ける
- 対象項目名はカンマ区切りで複数指定可能
- 有効化され、対象項目名が指定されている場合、該当する列の値の先頭が日本の47都道府県名（北海道、青森県...沖縄県）と一致する場合に、その都道府県名部分を削除する
- 指定された対象項目名が存在しない場合は、処理をスキップする（または警告を表示する）

#### 3.2.12 都道府県コード取得 (F12)

- 「都道府県コード」セクション内の専用チェックボックスで機能の有効/無効を切り替え
- 都道府県名が含まれる既存の「対象項目名」を指定する入力欄を設ける
- 生成される都道府県コードを格納する「新しい項目名」を指定する入力欄を設ける（デフォルト値: "都道府県コード"）
- 有効化され、対象項目名と新しい項目名が指定されている場合、対象項目の値の先頭が日本の47都道府県名と一致する場合に、対応するJIS X 0401準拠の2桁の都道府県コードを新しい項目名の列に追加する
- 都道府県名が見つからない場合、新しい列には空文字列を設定する
- 指定された対象項目名が存在しない場合、または新しい項目名が既存の項目名と重複する場合は、処理をスキップし警告を表示する

#### 3.2.13 文字列抽出 (F13)

- 「文字列抽出」セクション内のテキストエリアに設定を記述する
- 書式：`新項目名:抽出元項目:開始位置:文字数`
  - 各設定は改行で区切る
- **新項目名**: 抽出結果を格納する新しい列の名前を指定する
- **抽出元項目**: 文字列を抽出する既存の列の名前を指定する
- **開始位置**: 抽出を開始する文字の位置を1以上の整数で指定する (1始まり)
- **文字数**: 抽出する文字数を0以上の整数で指定する
- 指定された抽出元項目が存在しない場合、処理をスキップし警告を表示する
- 新項目名が既に存在する場合、処理を実行し既存の列を上書きする旨の警告を表示する
- 開始位置、文字数が整数でない場合、または開始位置が1未満、文字数が0未満の場合、処理をスキップし警告を表示する
- 抽出元項目の値が欠損値の場合、または開始位置が文字列長を超える場合、新しい列には空文字列を設定する
- 抽出元項目の値が数値等の場合、文字列に変換してから抽出処理を行う

## 4. ユーザーインターフェース

### 4.1 画面構成

ウェブアプリケーションは以下の主要なセクションで構成される：

1. **ヘッダー部**：アプリケーションタイトルと操作説明
2. **プロファイル管理セクション**
   - プロファイル選択ドロップダウン
   - プロファイル名入力フィールド
   - 保存・削除ボタン
3. **ファイル操作セクション**
   - ファイル選択ボタン（Google Drive Picker APIを利用）
   - 選択されたファイルの表示
   - 出力文字コード選択（UTF-8/Shift-JIS）
4. **設定セクション**：タブ形式またはアコーディオン形式で表示
   - **並べ替えタブ**：項目の並べ替え設定用テキストエリア
   - **結合タブ**：項目の結合設定用テキストエリア
   - **文字列抽出タブ**：文字列抽出設定用テキストエリア
   - **文字除去タブ**：文字の除去設定用テキストエリアと都道府県名除去設定
   - **文字追加タブ**：文字の追加設定用テキストエリア
   - **都道府県コードタブ**：都道府県コード取得設定
5. **プレビュー・操作セクション**
   - プレビュー表示エリア（表形式）
   - 変換実行ボタン
   - 保存ボタン

### 4.2 操作フロー

1. ウェブアプリケーションにアクセス
2. プロファイルの選択または新規作成
3. 変換設定の入力（各タブで設定）
4. Google Drive上のCSVファイルを選択
5. プレビューの確認
6. （必要に応じて設定を調整）
7. 保存ボタンのクリック
8. 保存先（Google Drive）と出力形式の指定
9. ファイルの保存

## 5. データ構造

### 5.1 プロファイルデータ

プロファイル情報は以下のいずれかの方法で保存：

1. **プロパティサービス**：ユーザープロパティとして保存
   ```javascript
   {
     "プロファイル名1": {
       "reorder": "項目A,,項目B,項目C...",
       "merge": "新項目名:項目1,項目2 区切り文字\n...",
       "extract": "新項目名1:元項目A:1:5\n新項目名2:元項目B:5:4",
       "remove": "項目名:除去文字1,除去文字2\n...",
       "add": "項目名:位置:追加文字\n...",
       "remove_prefecture": {
         "enabled": true,
         "column": "住所1,所在地"
       },
       "get_pref_code": {
         "enabled": true,
         "source_column": "住所1",
         "new_column": "都道府県コード"
       }
     },
     "プロファイル名2": {
       ...
     }
   }
   ```

2. **Google Sheets**：以下の構造で保存
   - シート名：「プロファイル」
   - 列構成：プロファイル名、並べ替え設定、結合設定、文字列抽出設定、文字除去設定、文字追加設定、都道府県名除去設定、都道府県コード設定

### 5.2 ファイル形式

- 入力：Google Drive上のCSVファイル
- 出力：
  - Google Drive上のCSVファイル（UTF-8またはShift-JIS）
  - Google Sheets（スプレッドシート）

## 6. 制約事項と注意点

- Google アカウントと適切な権限設定が必要
- GASの実行時間制限（6分）を考慮する必要がある
- GASの容量制限（50MB）の範囲内でのCSVファイル処理に制限される
- スクリプトプロパティの保存容量制限（500KB）を考慮したプロファイル管理が必要
- カラム名に特殊文字（コロン、カンマなど）が含まれる場合、操作が正しく機能しない可能性がある

## 7. エラー処理

| エラーID | エラー内容 | 対応 |
|----------|------------|------|
| E01 | ファイル読み込み失敗 | エラーメッセージを表示 |
| E02 | Google Drive APIエラー | エラーメッセージを表示し、再試行を促す |
| E03 | データ処理エラー | エラーメッセージを表示し、元のデータを維持 |
| E04 | プロファイル保存/読み込みエラー | エラーメッセージを表示 |
| E05 | 文字列抽出エラー | 設定形式不正、項目名不正、数値不正等の場合に警告を表示 |
| E06 | 実行時間制限エラー | 大容量ファイルでの処理中断時にメッセージを表示 |

## 8. 将来の拡張性

以下の機能拡張が検討可能である：

- 正規表現を用いた高度な文字列処理
- Excel形式の直接入出力サポート
- バッチ処理による複数ファイルの一括変換
- G Suite管理者による組織内共有プロファイルの設定
- ユーザー間でのプロファイル共有機能

## 9. 実装と配布

### 9.1 開発環境

- Google Apps Script エディタ
- Google Drive API
- Google Sheets API
- Google Picker API

### 9.2 アプリケーション作成

1. GASプロジェクトの作成
2. HTML/CSS/JavaScriptファイルの作成
3. 必要なAPIと権限の設定
4. ウェブアプリケーションとしての公開設定

### 9.3 配布方法

- ウェブアプリケーションとしてURLを共有
- スクリプトのコピーによる配布
- Google Workspaceマーケットプレイスへの公開（オプション）

## 10. パフォーマンス要件

- 一般的なCSVファイル（〜5MB）を10秒以内に処理
- Google Apps Scriptの実行時間制限（6分）を考慮した処理の最適化
- 大容量ファイルの場合は分割処理を検討

## 11. セキュリティ

- ウェブアプリケーションのアクセス設定（ドメイン内のみ、特定ユーザーのみなど）
- スクリプトの認証と承認プロセスの明確化
- ユーザーデータのプライバシー保護

## 12. 技術的実装の概要

### 12.1 バックエンド（GAS）

```javascript
// メイン関数（アプリケーション起動時）
function doGet() {
  return HtmlService.createTemplateFromFile('Index')
      .evaluate()
      .setTitle('CSVレイアウト変更ツール')
      .setFaviconUrl('URL_TO_FAVICON');
}

// CSVファイルを読み込む関数
function readCsvFromDrive(fileId) {
  // Google Drive APIを使用してファイルを読み込み
  // CSVデータを二次元配列として返す
}

// データ変換処理を行う関数
function processData(data, settings) {
  // 設定に基づいてデータ変換処理を実行
  // 変換後のデータを返す
}

// プロファイル管理関数
function saveProfile(name, settings) {
  // プロパティサービスまたはSheetsにプロファイルを保存
}

function getProfiles() {
  // 保存されているプロファイル一覧を取得
}

// 変換結果を保存する関数
function saveResultToDrive(data, fileName, format, folderId) {
  // Google Drive APIを使用して結果を保存
  // 保存したファイルのIDを返す
}
```

### 12.2 フロントエンド（HTML/JavaScript）

```html
<!-- Index.html -->
<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="https://ssl.gstatic.com/docs/script/css/add-ons1.css">
  <?!= include('CSS'); ?>
</head>
<body>
  <!-- アプリケーションUI構造 -->
  <div class="container">
    <!-- ヘッダー部 -->
    <div class="header">
      <h1>CSVレイアウト変更ツール</h1>
      <p>Google Drive上のCSVファイルを読み込み、項目の並べ替え、結合、文字の除去・追加などの操作を行うツールです。</p>
    </div>
    
    <!-- プロファイル管理セクション -->
    <div class="profile-section">
      <!-- プロファイル管理UI -->
    </div>
    
    <!-- ファイル操作セクション -->
    <div class="file-section">
      <!-- ファイル選択UI -->
    </div>
    
    <!-- 設定セクション -->
    <div class="settings-section">
      <!-- 各種設定タブ -->
    </div>
    
    <!-- プレビュー・操作セクション -->
    <div class="preview-section">
      <!-- プレビュー表示と操作ボタン -->
    </div>
  </div>
  
  <?!= include('JavaScript'); ?>
</body>
</html>
```

### 12.3 API連携

- Google Drive APIを使用したファイル操作
- Google Picker APIを使用したファイル選択インターフェース
- Google Sheets APIを使用したデータ処理とプロファイル管理（必要に応じて）
