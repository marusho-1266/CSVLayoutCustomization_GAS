# CSVレイアウト変更ツール (Google Apps Script版)

## 概要

このツールは、ローカルにあるCSVファイルのレイアウト（項目の構成や内容）を柔軟に変更するためのGoogle Apps Scriptで実装されたウェブアプリケーションです。

CSVファイルを読み込み、項目の並べ替え、結合、文字列の抽出、文字の除去・追加、都道府県関連の処理などを行った後、結果をGoogle Driveに**UTF-8エンコーディングのCSVファイル**として保存します。

## 主な機能

*   **CSVファイル読み込み:** ローカルのCSVファイルを読み込みます。読み込み時にファイルの文字コード（UTF-8またはShift-JIS）を指定できます。
*   **項目の並べ替え:** 列の順序を変更したり、空の列を挿入したりできます。連続したカンマ（例: `項目A,,項目B`）を指定することで、空の列を挿入することができます。
*   **複数項目の結合:** 複数の列を指定した区切り文字で結合し、新しい列を作成します。
*   **文字列抽出:** 指定した列から、指定した位置と文字数で文字列を抽出し、新しい列を作成します。
*   **文字の除去:** 指定した列から、特定の文字（複数指定可）を削除します。
*   **文字の追加:** 指定した列の値の前または後に、固定の文字列を追加します。
*   **文字列置換:** 指定した列内の特定の文字列を、別の文字列にすべて置換します。
*   **都道府県名除去:** 住所などが含まれる列から、先頭の都道府県名（例: "東京都"）を削除します。
*   **都道府県コード取得:** 都道府県名が含まれる列から、対応する2桁の都道府県コード（JIS X 0401準拠）を新しい列として取得します。
*   **プレビュー表示:** 変換後のデータの先頭10行をプレビュー表示します。
*   **変換結果の保存:** 変換後のデータをGoogle DriveのルートフォルダにCSVファイル（UTF-8固定）として保存します。保存時にヘッダー行を除去するかどうかを選択できます。
*   **プロファイル管理:** 変換設定を名前を付けて保存し、後で呼び出したり削除したりできます（設定はユーザー個人のプロパティに保存されます）。

## 使い方

1.  **デプロイ:** Google Apps Script プロジェクトをウェブアプリケーションとしてデプロイします。（初回のみ）
2.  **アクセス:** デプロイされたウェブアプリケーションのURLにアクセスします。
3.  **プロファイル選択（任意）:** 以前保存した設定を使用する場合は、「プロファイル管理」セクションのドロップダウンからプロファイルを選択します。新規に設定する場合は、「新規プロファイル」のままにします。
4.  **ファイル選択:**
    *   「ファイル操作」セクションの「CSVファイルを選択」ボタンをクリックします。
    *   ローカルのCSVファイルを選択します。
    *   **「入力文字コード」**で、選択したファイルの文字コード（UTF-8 または Shift-JIS）を正しく指定します。
    *   ファイルが読み込まれると、プレビューエリアに内容が表示されます。
5.  **変換設定:**
    *   「変換設定」セクションの各タブ（並べ替え, 結合, 文字列抽出, 文字除去, 文字追加, 都道府県）を開き、必要な設定を入力します。
    *   設定内容は各タブ内のヘルプテキストを参照してください。
6.  **プロファイル保存（任意）:** 設定内容を後で再利用したい場合は、「プロファイル管理」セクションで「プロファイル名」を入力し、「保存」ボタンをクリックします。
7.  **変換実行:** 「プレビュー・操作」セクションの「変換実行」ボタンをクリックします。
8.  **プレビュー確認:** 変換後のデータがプレビューエリアに表示されるので、意図した通りに変換されているか確認します。
9.  **保存:** 「保存」ボタンをクリックします。変換結果が `converted_data.csv` という名前でGoogle Driveのルートフォルダに保存され、ファイルへのリンクが表示されます。保存時に「ヘッダー行を除去して保存」にチェックを入れると、ヘッダー行なしで保存されます。

## 動作環境

*   実行環境: Google Apps Script (GAS)
*   アクセス手段: ウェブアプリケーション（Google Chromeなど主要ブラウザ推奨）
*   必要サービス:
    *   Google アカウント
    *   Google Drive

## 設定項目詳細

### 並べ替え
カンマ区切りで出力したい項目名を順番に指定します。元のファイルにない項目名は無視されます。カンマを連続させると (`項目A,,項目B`)、その位置に空の列が挿入されます。

*(例)* `ID,氏名,,住所,備考`

### 結合
`新項目名:結合元項目1,結合元項目2 区切り文字` の形式で、1行に1つの結合設定を記述します。区切り文字は省略可能です。

*(例)* `氏名フル:姓,名 ` (姓と名をスペース区切りで結合)

### 文字列抽出
`新項目名:抽出元項目:開始位置:文字数` の形式で、1行に1つの抽出設定を記述します。開始位置は1から数えます。

*(例)* `郵便番号上3桁:郵便番号:1:3`

### 文字除去
`項目名:除去する文字1,除去する文字2...` の形式で、1行に1つの除去設定を記述します。指定した項目から、カンマ区切りの文字をすべて削除します。
「都道府県名を除去」にチェックを入れると、指定した項目（カンマ区切りで複数指定可）の先頭にある都道府県名を削除します。

*(例)* `電話番号:-,(,)`
*(例)* 都道府県名除去: チェックON, 対象項目: `住所1,所在地`

### 文字追加
`項目名:位置:追加文字` の形式で、1行に1つの追加設定を記述します。位置は「前」または「後」を指定します。

*(例)* `管理番号:前:ABC-`

### 文字列置換
`対象列名:検索文字列:置換後文字列` の形式で、1行に1つの置換ルールを記述します。指定した列内のすべての「検索文字列」を「置換後文字列」に置き換えます。

*(例)* `備考:（株）:(株式会社)`
*(例)* `住所:東京都:ＴＫ都`

### 都道府県
「都道府県コードを取得」にチェックを入れると、指定した「都道府県名を含む項目」から都道府県名を判定し、対応する2桁のコードを「都道府県コードを格納する項目」（デフォルト: "都道府県コード"）という名前の新しい列に追加します。

*(例)* チェックON, 都道府県名を含む項目: `住所`, 都道府県コードを格納する項目: `PrefCode`

## プロファイル管理

よく使う変換設定は、「プロファイル管理」セクションで名前を付けて保存できます。
*   **保存:** 設定を入力後、プロファイル名を入力して「保存」ボタンをクリックします。
*   **読み込み:** ドロップダウンから保存したプロファイル名を選択すると、設定がフォームに読み込まれます。
*   **削除:** ドロップダウンから削除したいプロファイル名を選択し、「削除」ボタンをクリックします（確認ダイアログが表示されます）。

*(プロファイルデータ例)*
```javascript
{
  "プロファイル名1": {
    "reorder": "項目A,,項目B,項目C...",
    "merge": "新項目名:項目1,項目2 区切り文字\n...",
    "extract": "新項目名1:元項目A:1:5\n新項目名2:元項目B:5:4",
    "remove": "項目名:除去文字1,除去文字2\n...",
    "add": "項目名:位置:追加文字\n...",
    "replace": "対象列名:検索文字列:置換後文字列\n...",
    "remove_prefecture": {
      "enabled": true,
      "column": "住所1,所在地"
    },
    "get_pref_code": {
      "enabled": true,
      "source_column": "住所1",
      "new_column": "都道府県コード"
    }
  }
}

## 制約事項

*   **Googleアカウントが必要です。** スクリプトの実行にはGoogleアカウントによる承認が必要です。
*   **GASの実行時間制限:** 一度に処理できるデータ量には限りがあります（通常6分）。非常に大きなファイルの場合、処理がタイムアウトする可能性があります。
*   **ブラウザのメモリ制限:** 非常に大きなファイルを読み込むと、ブラウザが応答しなくなる可能性があります。
*   **プロファイル保存容量:** プロファイルはスクリプトプロパティに保存され、容量制限（約500KB）があります。非常に多くの、または複雑なプロファイルを保存すると制限に達する可能性があります。
*   **出力文字コード:** **CSVファイルの出力はUTF-8に固定されます。** Shift-JISでの出力はGoogle Apps Scriptの制限によりサポートされていません。
*   **保存先:** ファイルはGoogle Driveのルートフォルダに保存されます。
*   **ヘッダー除去:** ヘッダー行を除去して保存する場合、プレビュー表示には影響しません。保存時のみヘッダー行が除去されます。

## デプロイ方法

1.  Google Apps Script エディタでプロジェクトを開きます。
2.  右上の「デプロイ」ボタンをクリックし、「新しいデプロイ」を選択します。
3.  「種類の選択」で「ウェブアプリ」を選択します。
4.  「説明」を入力（任意）。
5.  「ウェブアプリ」の設定:
    *   **次のユーザーとして実行:** 「自分」を選択します。
    *   **アクセスできるユーザー:** 「全員」（Googleアカウントを持つ全員）または組織内の適切な範囲を選択します。
6.  「デプロイ」ボタンをクリックします。
7.  （初回デプロイ時）「アクセスを承認」ボタンをクリックし、表示される手順に従ってスクリプトに必要な権限を許可します。
8.  表示される「ウェブアプリのURL」をコピーし、このURLにアクセスしてツールを使用します。